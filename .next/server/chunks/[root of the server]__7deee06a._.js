module.exports = {

"[project]/.next-internal/server/app/api/confirmation-details/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route.runtime.dev.js [external] (next/dist/compiled/next-server/app-route.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/@opentelemetry/api [external] (@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@opentelemetry/api", () => require("@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page.runtime.dev.js [external] (next/dist/compiled/next-server/app-page.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/child_process [external] (child_process, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}}),
"[project]/src/app/api/confirmation-details/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// src/app/api/confirmation-details/route.ts
__turbopack_context__.s({
    "GET": (()=>GET),
    "dynamic": (()=>dynamic)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$stripe$2f$esm$2f$stripe$2e$esm$2e$node$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/stripe/esm/stripe.esm.node.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/date-fns/format.mjs [app-route] (ecmascript) <locals>"); // Removed unused addDays
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$parseISO$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/parseISO.mjs [app-route] (ecmascript)");
;
;
;
const stripe = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$stripe$2f$esm$2f$stripe$2e$esm$2e$node$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"](process.env.STRIPE_SECRET_KEY, {
});
// Removed unused calculateEndDate helper function
// Helper function to call the email sending API
async function sendNotificationEmail(details) {
    const internalAppUrl = 'http://localhost:9002';
    const emailApiUrl = `${internalAppUrl}/api/send-email`;
    console.log(`Attempting to POST to internal API route: ${emailApiUrl}`);
    try {
        const response = await fetch(emailApiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(details)
        });
        console.log(`Response status from ${emailApiUrl}: ${response.status}`);
        if (!response.ok) {
            const responseText = await response.text();
            console.error(`Error response body from ${emailApiUrl}:`, responseText);
            try {
                const errorData = JSON.parse(responseText);
                console.error(`Email API Error (${response.status}):`, errorData.error || 'Unknown error (parsed JSON)');
            } catch (parseError) {
                console.error(`Email API Error (${response.status}): Could not parse error response as JSON.`);
            }
        } else {
            const successData = await response.json();
            console.log(`Email notification triggered successfully via ${emailApiUrl}. Response:`, successData);
        }
    } catch (error) {
        if (error instanceof TypeError && error.message.includes('fetch failed')) {
            console.error(`Network error fetching ${emailApiUrl}:`, error.cause ?? error);
        } else {
            console.error(`Generic error fetching internal API ${emailApiUrl}:`, error);
        }
    }
}
const dynamic = 'force-dynamic';
async function GET(request) {
    console.log(`Received request for /api/confirmation-details`);
    const { searchParams } = new URL(request.url);
    const sessionId = searchParams.get('session_id');
    console.log(`Session ID: ${sessionId}`);
    if (!sessionId) {
        console.error('Missing session_id parameter');
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Missing session_id'
        }, {
            status: 400
        });
    }
    try {
        console.log('Retrieving Stripe session...');
        const session = await stripe.checkout.sessions.retrieve(sessionId);
        console.log('Stripe session retrieved successfully.');
        console.log(`Session ${sessionId} payment status: ${session.payment_status}`);
        if (session.payment_status !== 'paid') {
            console.warn(`Email notification skipped: Payment status is ${session.payment_status}`);
        }
        // Extract data from metadata using new keys
        const entryDateISO = session.metadata?.entryDate; // e.g., "2024-07-25"
        const exitDateISO = session.metadata?.exitDate; // e.g., "2024-07-28"
        const duration = session.metadata?.durationDays;
        const totalPrice = session.amount_total ? session.amount_total / 100 : null;
        const currency = session.currency || 'usd';
        const licensePlate = session.metadata?.licensePlate;
        const truckNumber = session.metadata?.truckNumber;
        const paymentStatus = session.payment_status;
        // Format dates for display
        const formattedEntryDate = entryDateISO ? (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$parseISO$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["parseISO"])(entryDateISO), "PPP") : null; // e.g., Jul 25, 2024
        const formattedExitDate = exitDateISO ? (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$parseISO$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["parseISO"])(exitDateISO), "PPP") : null;
        console.log(`Retrieved Dates: Entry=${formattedEntryDate}, Exit=${formattedExitDate}, Duration=${duration}`);
        // Prepare data for frontend and email using new terminology
        const bookingDetails = {
            entryDate: formattedEntryDate,
            exitDate: formattedExitDate,
            duration: duration || null,
            totalPrice: totalPrice,
            currency: currency,
            licensePlate: licensePlate || null,
            truckNumber: truckNumber || null,
            paymentStatus: paymentStatus
        };
        console.log('Prepared booking details for response.');
        // Trigger Email ONLY if Payment is Successful, using new fields
        if (paymentStatus === 'paid') {
            console.log('Payment status is paid. Triggering email notification...');
            sendNotificationEmail({
                // Use new keys for the email content
                entryDate: formattedEntryDate,
                exitDate: formattedExitDate,
                duration: duration,
                totalPrice: totalPrice,
                currency: currency,
                licensePlate: licensePlate,
                truckNumber: truckNumber
            }).catch((err)=>console.error("Error calling sendNotificationEmail function:", err));
        }
        console.log('Sending booking details response to client.');
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(bookingDetails);
    } catch (error) {
        console.error("Error in /api/confirmation-details route:", error);
        if (error instanceof Error) {
            if (error.name === 'StripeInvalidRequestError') {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: 'Invalid session ID provided.'
                }, {
                    status: 404
                });
            }
            console.error(`Stripe API or other error: ${error.message}`);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: error.message
            }, {
                status: 500
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'An unknown error occurred while fetching session details.'
        }, {
            status: 500
        });
    }
}
}}),

};

//# sourceMappingURL=%5Broot%20of%20the%20server%5D__7deee06a._.js.map