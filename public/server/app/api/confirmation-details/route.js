(()=>{var e={};e.id=180,e.ids=[180],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1630:e=>{"use strict";e.exports=require("http")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4735:e=>{"use strict";e.exports=require("events")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},6487:()=>{},7007:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>f,serverHooks:()=>P,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{GET:()=>g,dynamic:()=>m});var o=r(6559),n=r(8088),i=r(7719),a=r(2190),l=r(7877),c=r(1501),u=r(9615);let p=new l.A(process.env.STRIPE_SECRET_KEY,{});async function d(e){let t="http://localhost:9002/api/send-email";console.log(`Attempting to POST to internal API route: ${t}`);try{let r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(console.log(`Response status from ${t}: ${r.status}`),r.ok){let e=await r.json();console.log(`Email notification triggered successfully via ${t}. Response:`,e)}else{let e=await r.text();console.error(`Error response body from ${t}:`,e);try{let t=JSON.parse(e);console.error(`Email API Error (${r.status}):`,t.error||"Unknown error (parsed JSON)")}catch(e){console.error(`Email API Error (${r.status}): Could not parse error response as JSON.`)}}}catch(e){e instanceof TypeError&&e.message.includes("fetch failed")?console.error(`Network error fetching ${t}:`,e.cause??e):console.error(`Generic error fetching internal API ${t}:`,e)}}let m="force-dynamic";async function g(e){console.log("Received request for /api/confirmation-details");let{searchParams:t}=new URL(e.url),r=t.get("session_id");if(console.log(`Session ID: ${r}`),!r)return console.error("Missing session_id parameter"),a.NextResponse.json({error:"Missing session_id"},{status:400});try{console.log("Retrieving Stripe session...");let e=await p.checkout.sessions.retrieve(r);console.log("Stripe session retrieved successfully."),console.log(`Session ${r} payment status: ${e.payment_status}`),"paid"!==e.payment_status&&console.warn(`Email notification skipped: Payment status is ${e.payment_status}`);let t=e.metadata?.entryDate,s=e.metadata?.exitDate,o=e.metadata?.durationDays,n=e.amount_total?e.amount_total/100:null,i=e.currency||"usd",l=e.metadata?.licensePlate,m=e.metadata?.truckNumber,g=e.payment_status,f=t?(0,c.GP)((0,u.H)(t),"PPP"):null,y=s?(0,c.GP)((0,u.H)(s),"PPP"):null;return console.log(`Retrieved Dates: Entry=${f}, Exit=${y}, Duration=${o}`),console.log("Prepared booking details for response."),"paid"===g&&(console.log("Payment status is paid. Triggering email notification..."),d({entryDate:f,exitDate:y,duration:o,totalPrice:n,currency:i,licensePlate:l,truckNumber:m}).catch(e=>console.error("Error calling sendNotificationEmail function:",e))),console.log("Sending booking details response to client."),a.NextResponse.json({entryDate:f,exitDate:y,duration:o||null,totalPrice:n,currency:i,licensePlate:l||null,truckNumber:m||null,paymentStatus:g})}catch(e){if(console.error("Error in /api/confirmation-details route:",e),e instanceof Error){if("StripeInvalidRequestError"===e.name)return a.NextResponse.json({error:"Invalid session ID provided."},{status:404});return console.error(`Stripe API or other error: ${e.message}`),a.NextResponse.json({error:e.message},{status:500})}return a.NextResponse.json({error:"An unknown error occurred while fetching session details."},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/confirmation-details/route",pathname:"/api/confirmation-details",filename:"route",bundlePath:"app/api/confirmation-details/route"},resolvedPagePath:"/home/user/studio/src/app/api/confirmation-details/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:x,serverHooks:P}=f;function h(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:x})}},8335:()=>{},8354:e=>{"use strict";e.exports=require("util")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9646:e=>{"use strict";e.exports=require("child_process")}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,580,651],()=>r(7007));module.exports=s})();